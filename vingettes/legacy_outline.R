devtools::load_all()
library(rjmc)
library(data.table)
library(lubridate)
library(ggdist)
library(posterior)
library(bayesplot)
library(ggdist)

sourceCpp("src/likelihoods/ll_wave2.cpp")


gambia_pvnt_w2 <- get_data_titre_model_wave2() # This is the empirical prior for the exposure time
gambia_exp_w2 <- get_exposures_wave2() # This is the empirical prior for the exposure time
exp_prior_w2 <- get_exp_prior_wave2() # This is the empirical prior for the exposure time
# exp_prior_w2$prob <- 0.001
gambia_exp_w2$inf_pd_time
gambia_exp_w2$vax_time

# Define parameters, priors and support for ab kinetics model (a, b, c), observational model (sigma) and
# the correlate of protection curve (beta0, beta1)
# Format is [param_name, lower_bound, upper_bound, prior_function (in R), parameter_1 in prior function, parameter_2 in prior function (if needed)]
# add_par_df adds to the par_tab
par_tab <- bind_rows(
  add_par_df("a_vax", 0.5, 1.5, "norm",  1, 0.5), # ab kinetics
  add_par_df("b_vax", 0, 1, "norm",  0.3, 0.05), # ab kinetics
  add_par_df("c_vax", 0.3, 4, "unif", 0.3,  4), # ab kinetics
  add_par_df("a_pd", 0.5, 1.5, "norm",  1, 0.5), # ab kinetics
  add_par_df("b_pd", 0, 1, "norm",  0.3, 0.05), # ab kinetics
  add_par_df("c_pd", 0.3, 4, "unif", 0.3,  4), # ab kinetics
  add_par_df("a_d", 0.5, 1.5, "norm",  1, 0.5), # ab kinetics
  add_par_df("b_d", 0, 1, "norm",  0.3, 0.05), # ab kinetics
  add_par_df("c_d", 0.3, 4, "unif", 0.3,  4), # ab kinetics

  add_par_df("wane", 0, 0.1, "unif", 0, 0.1), # ab kinetics

  add_par_df("sigma_obs", 0.01, 5, "exp", 10, NA), # observational model
  add_par_df("beta0", -10, 10, "unif", -10, 10), # cop model (not used here)
  add_par_df("beta1", -10, 10, "unif", -10, 10) # cop model (not used here)
)



# Likelihood on the observational model, can be defined as anything [or put in c++]
evaluateLogLikelihood <- function(params, jump, jump_inf, covariance, datalist) {

  ll <- evaluateLogLikelihood_cpp(params, jump, jump_inf, covariance, datalist)
  # datalist is data into the model which is useful
  ll
}

# Logistic correlate of protection model, this is added to the likelihood for each exposed person. Can be defined as anything
cop_func <- function(jump, jumpinf, params, initialTitreValue) {
  ll <- 0
  # COP parameters
  beta0 <- params[12]
  beta1 <- params[13]
  p <- 1.0 / (1.0 + exp(- (beta0 + beta1 * initialTitreValue) ) )
  ll <- jumpinf * log(p) + (1 - jumpinf) * log(1 - p)

  ll
}

# Run reversible jump mcmc
runsaveRJMCMC <- function(filename, modelname, evaluateLogLikelihood, data_t_raw, par_tab, exp_prior, cop_func) {

  # Clean the data into a format for the sampler
  # data_titre_model format is [id, time, titre]
  # Generate the data_t format
  gambia_exp_w2_d <- gambia_exp_w2 %>% filter(inf_d_time > -1)
  data_t <- generate_data_t(gambia_pvnt_w2, dplyr::select(gambia_exp_w2_d, pid, id, inf_time = inf_d_time) )
  data_t$inf_pd_time <- gambia_exp_w2$inf_pd_time
  data_t$vax_time <- gambia_exp_w2$vax_time


  # This function creates the list of functions needed for the rjmc_full_func
  model_define <- createModelRJCMCFull(evaluateLogLikelihood, par_tab, cop_func)
  model_define <- addExposurePrior(model_define, data_t, exp_prior, type = "empirical")

  # Settings used for the rjmcmc model, still playing around with optimal settings
  settings <-  list(
    numberChainRuns = 4,
    numberCores = 4,
    iterations = 2000,
    burninPosterior = 1000,
    thin = 1,
    consoleUpdates = 1,
    numberFittedPar = model_define$namesOfParameters %>% length,
    onAdaptiveCov = TRUE,
    updatesAdaptiveCov = 100,
    burninAdaptiveCov = 1000,
    onAdaptiveTemp = TRUE,
    updatesAdaptiveTemp = 10,
    onDebug = FALSE,
    lowerParBounds = model_define$lowerParSupport_fitted,
    upperParBounds = model_define$upperParSupport_fitted,
    covarInitVal = 1e-2, # make very small if struggling to sample to beginning
    covarInitValAdapt = 1e-2, # make very small if struggling to sample to beginning
    covarMaxVal = 1, # decrease if struggling to sample in the middle
    runParallel = TRUE,
    lengthJumpVec = data_t$N,
    noGibbsSteps = 5
  )
  post <- rjmc_full_func(model = model_define, data = data_t, settings = settings)
  fitfull <- list(post = post,  model = model_define, data_t = data_t, par_tab = par_tab, exp_prior = exp_prior)

  dir.create(here::here("outputs", "fits", filename), showWarnings = FALSE)
  dir.create(here::here("outputs", "fits", filename, "figs"), showWarnings = FALSE)

  saveRDS(fitfull, here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
}

runsaveRJMCMC( "test/transvir", "wave2", evaluateLogLikelihood, gambia_pvnt_w2, par_tab, exp_prior_w2, cop_func)


filename <- "test/transvir"
modelname <- "wave2"
outputfull <- readRDS(file = here::here("outputs", "fits", filename, paste0("pp_", modelname, ".RDS")))

fit_states <- outputfull$fit_states
filename <- outputfull$filename
modelname <- outputfull$modelname

fitfull <- readRDS(here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
data_t <- fitfull$data_t
N <- data_t$N

df_data_alt <- data.frame(
  id = data_t$id_full,
  time = data_t$times_full,
  titre = data_t$titre_full
)

df_data <- data.frame(
  id = 1:N,
  start_titre = data_t$initialTitreValue
)

# a) Infection over whole process
fit_states_exp_time <- fit_states %>% select(id, exp_ind) %>%
  summarise(exp_post = mean(exp_ind), .by = "id")
ids_inf <- fit_states_exp_time %>% filter(exp_post > 0.8) %>% pull(id)

fit_states_exp_prob <- fit_states %>% select(id, exp_ind, exp_time) %>%
  filter(exp_time > -1) %>% group_by(id) %>%
  summarise(exp_time = mean(exp_time))
# a) Infection over whole process


# Fig A. Compare histograms
fit_states_exp_prob %>% left_join(df_data_alt) %>% filter(id %in% ids_inf, time > 0 ) %>%
  ggplot() +
  geom_histogram(aes(x = exp_time, y = ..density..)) +
  geom_col(data = exp_time, aes(x = day, y = prob), fill = "red", alpha = 0.5) +
  theme_bw()

# Fig B. Compare titre at start of study to end
fit_states_exp_time %>% left_join(df_data_alt) %>% filter(id %in% ids_inf) %>%
  ggplot() +
  geom_point(aes(x = time, y = titre, group = id, fill = exp_post), shape = 21, size = 3, alpha = 0.6) +
  geom_line(aes(x = time, y = titre, group = id, color = exp_post), shape = 21, size = 0.5, alpha = 0.9) +
  theme_bw()

# Fig C. Individual-level plots of exposure times
exposure_plot <- fit_states %>% filter(exp_ind == 1, inf_ind == 1) %>% select(id, exp_time) %>% group_by(id) %>% mean_qi(exp_time) %>%
  filter(id %in% ids_inf)

post <- fitfull$post
mcmc_mean <- post$mcmc %>% combine %>% as.data.frame %>%
  summarise(across(c(a_d, b_d, c_d, sigma_obs), mean))

ab_function <- function(a, b, c, T) {
  1:T %>% map(
    function(t) {
      if (t < 14) {
        titre_init <- 0 +  (log(exp(a) +  exp(c)) * (t) / 14);
      } else {
        titre_init <- 0 + (log(exp(a) * exp(-b/10 * ((t) - 14)) + exp(c)));
      }
    }
  ) %>% unlist
}

exposure_plot_trim <- exposure_plot %>% select(id, exp_time)

traj_exposure <- map_df(1:nrow(exposure_plot_trim),
                        ~data.frame(
                          id = exposure_plot_trim[[.x, 1]],
                          time = 1:300,
                          titre = c(rep(0, round(exposure_plot_trim[[.x, 2]], 0)), ab_function(mcmc_mean[["a_d"]], mcmc_mean[["b_d"]], mcmc_mean[["c_d"]], 300 - round(exposure_plot_trim[[.x, 2]], 0)))
                        )
)

exposure_plot %>%
  ggplot() +
  geom_rect(aes(xmin = .lower, xmax = .upper, ymin = 0, ymax = 3), fill = "red", alpha = 0.4) +
  geom_rect(aes(xmin = exp_time - 2, xmax = exp_time + 2, ymin = 0, ymax = 3), fill = "red", alpha = 0.8) +
  geom_line(data = traj_exposure, aes(x = time, y = titre, group = id), alpha = 1) +
  geom_point(dat = fit_states_exp_prob %>% left_join(df_data_alt) %>% filter(id %in% ids_inf),
             aes(x = time, y = titre, group = id), shape = 21, size = 3, alpha = 0.6) +
  theme_bw() +
  labs(x = "Time of exposure", y = "Number of exposures") +
  ggtitle("Posterior distribution of exposure times") + facet_wrap(vars(id))



postprocess_run( "test/transvir", "wave2", 4)
outputfull <- readRDS(file = here::here("outputs", "fits", "test/transvir", paste0("pp_", "wave2", ".RDS")))


# plot_trace(outputfull)
filename <- outputfull$filename
modelname <- outputfull$modelname

fitfull <- readRDS(here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
post <- fitfull$post


post$mcmc %>% combine %>% summary
p1 <- post$mcmc %>% mcmc_trace
p2 <- post$lpost %>% ggplot() + geom_line(aes(x = sample_no, y = lpost, color = chain_no))
p1 / p2




library(patchwork)
# plot_exp_rec
fit_states <- outputfull$fit_states
filename <- outputfull$filename
modelname <- outputfull$modelname

fitfull <- readRDS(here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
data_t <- fitfull$data_t
N <- data_t$N

df_data <- data.frame(
  id = 1:N,
  start_titre = data_t$initialTitreValue
)

# a) Infection over whole process
fit_states_exp_prob <- fit_states %>% select(id, exp_ind) %>% summarise(exp_post = mean(exp_ind), .by = "id")

figA <- fit_states_exp_prob %>% left_join(df_data) %>%
  ggplot() +
  geom_point(aes(x = start_titre, y = exp_post), shape = 21, size = 3, alpha = 0.6) +
  theme_bw() +
  ylim(0, 1) +
  labs(x = "Titre at start of study", y = "Posterior probability of exposure", fill = "Exposure and infection status") +
  ggtitle("Posterior plots of probability of exposure compared to simulated data")

no_exp_fit_df <- fit_states %>% select(id, sample, exp_ind) %>% summarise(exp_ind_sum = sum(exp_ind), .by = "sample")

figB <- no_exp_fit_df %>% summarise(n = n()  / 4000, .by = exp_ind_sum) %>%
  ggplot() +
  geom_col(aes(x = exp_ind_sum, y = n), alpha = 0.8) +
  theme_bw()  +
  labs(y = "Posterior density", x = expression("Estimated number of exposures in epidemic, n"[Z])) +
  ggtitle("Recovery of population-level exposure burden")

figB + plot_annotation(tag_levels = "A")

# plot_exp_times_rec


fit_states <- outputfull$fit_states
filename <- outputfull$filename
modelname <- outputfull$modelname

fitfull <- readRDS(here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
data_t <- fitfull$data_t
N <- data_t$N

df_data <- data.frame(
  id = 1:N,
  start_titre = data_t$initialTitreValue
)
fit_states_exp_prob <- fit_states %>% select(id, exp_ind) %>% summarise(exp_post = mean(exp_ind), .by = "id")

dataplt <- fit_states %>% filter(exp_ind == 1) %>% select(id, exp_time) %>% group_by(id) %>% mean_qi(exp_time) %>% left_join(fit_states_exp_prob)

pid_order1 <- dataplt %>% arrange(exp_time) %>% pull(id)

figB <- dataplt %>% mutate(id = factor(id, levels = pid_order1)) %>%
  ggplot() +
  geom_linerange(aes(y = id, xmin = .lower, xmax = .upper, color = exp_post)) +
  geom_point(aes(y = id, x = exp_time)) +
  labs(x = "Time in study", y = "ID", fill = "Posterior probability of exposure") + theme_bw() +
  theme(axis.text.y = element_blank()) +
  ggtitle("Recovery of timings of exposure over epidemic")


dataplt_inf <- fit_states %>% filter(inf_ind == 1) %>% select(id, exp_time) %>% group_by(id) %>% mean_qi(exp_time)

figC <- dataplt_inf %>% select(id, exp_time) %>%
  rename(`Model recovery` = exp_time) %>%
  pivot_longer(!id, names_to = "type", values_to = "time") %>%
  ggplot() +
  geom_density(aes(x = time, y = ..count.., fill = type), size = 2, alpha = 0.5, shape = 21) +
  theme_bw()  +
  labs(x = "Time in study", y = "Number of people infected daily", fill = "") +
  ggtitle("Recovery of infection timings")


figB / figC + plot_annotation(tag_levels = "A")

# plot_cop_rec


fit_states <- outputfull$fit_states
filename <- outputfull$filename
modelname <- outputfull$modelname

fitfull <- readRDS(here::here("outputs", "fits", filename, paste0("fit_", modelname, ".RDS")))
post <- fitfull$post

reps <-  post$mcmc %>% combine %>% as.data.frame  %>% pivot_longer(everything(), names_to = "param", values_to = "value") %>%
  mutate(type = "Posterior distribution") %>% filter(param %in% c("beta0", "beta1"))

b0_rep <- reps %>% filter(param == "beta0") %>% pull(value)
b1_rep <- reps %>% filter(param == "beta1") %>% pull(value)

biomarker_protection <- function(biomarker_quantity, biomarker_prot_midpoint, biomarker_prot_width) {
  risk <- 1 - 1/(1 + exp(biomarker_prot_width * (biomarker_quantity - biomarker_prot_midpoint)))
  return(risk)
}

lol <- 1:1000 %>% purrr::map_df(
  ~data.frame(
    t = seq(0, 4, 0.1),
    vals = 1.0 / (1.0 + exp(-(b0_rep[.x] + b1_rep[.x] * seq(0, 4, 0.1))))
  )
)

lol %>% ggplot() +
  stat_lineribbon(aes(x = t, y = vals, color = "Recovered COP curve"), fill = "blue", alpha = 0.5, .width = c(0.5, 0.95)) +
  theme_bw() +
  ylim(0, 1) +
  labs(x = expression("Titre at start of study Y"[j]^0), y = expression("Posterior probability of infection for correlate of protection, f"[cop]*"(Y"[j]^0*", "*theta[cop]*")"), color = "Curve type")


plot_trace(outputfull)
plot_abkinetics(outputfull)
plot_inf_rec(outputfull)
plot_exp_rec(outputfull)
plot_exp_times_rec(outputfull)
plot_cop_rec(outputfull)

postprocessFigs("test/transvir", "wave1", 4)

N = datalist$N
knownInfsVec =  datalist$knownInfsVec
knownInfsN = datalist$knownInfsN
knownInfsDate = datalist$knownInfsDate
endTitreTime = datalist$endTitreTime
